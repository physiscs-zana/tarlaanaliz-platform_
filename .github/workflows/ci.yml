name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'alembic/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'alembic/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'

permissions:
  contents: read
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  lint:
    name: Lint & Format (Ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check src/ tests/ alembic/ --select E9,F63,F7,F82

      - name: Run ruff format check (focused)
        run: ruff format --check tests/unit/test_calibration_gate.py

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run mypy
        run: python -m mypy --config-file pyproject.toml src

  unit-tests:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Verify submodule checkout
        shell: bash
        run: |
          set -euo pipefail
          echo "Submodules (recursive):"
          git submodule status --recursive
          test -d "contracts"
          echo "contracts HEAD:"
          git -C contracts rev-parse HEAD

      - name: Detect contracts schema changes
        id: contracts_filter
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi

          echo "BASE=$BASE"
          echo "HEAD=$HEAD"

          changed="$(git diff --name-only "$BASE" "$HEAD" || true)"
          echo "$changed"

          if ! echo "$changed" | grep -qx "contracts"; then
            echo "run_contracts_tests=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OLD="$(git show "$BASE":contracts)"
          NEW="$(git show "$HEAD":contracts)"
          echo "contracts old=$OLD new=$NEW"

          git -C contracts fetch --depth=50 origin "$OLD" "$NEW" || git -C contracts fetch origin "$OLD" "$NEW"

          if git -C contracts diff --name-only "$OLD" "$NEW" -- schemas/ | grep -q .; then
            echo "run_contracts_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_contracts_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run contracts tests (only if schemas changed)
        if: steps.contracts_filter.outputs.run_contracts_tests == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          python -m pip install pytest jsonschema
          python -m pip install -e ./contracts || true
          python -m pytest -q contracts/tests

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run unit tests with coverage
        run: pytest tests/unit/ -m unit --cov=src --cov-report=xml --cov-report=term-missing -q || pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing -q --ignore=tests/integration --ignore=tests/e2e

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage.xml
          retention-days: 7

  migration-check:
    name: Migration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install alembic sqlalchemy

      - name: Validate migration chain
        run: |
          python -c "
          import os, sys
          migration_dir = 'alembic/versions'
          if not os.path.isdir(migration_dir):
              print('Migration directory not found')
              sys.exit(1)
          files = [f for f in os.listdir(migration_dir) if f.endswith('.py') and not f.startswith('__')]
          print(f'Found {len(files)} migration files')
          for f in sorted(files):
              print(f'  - {f}')
          "

  status-check:
    name: Backend CI Status
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-tests, migration-check]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type Check: ${{ needs.type-check.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Migration Check: ${{ needs.migration-check.result }}"

          if [ "${{ needs.lint.result }}" = "failure" ] || \
             [ "${{ needs.unit-tests.result }}" = "failure" ] || \
             [ "${{ needs.migration-check.result }}" = "failure" ]; then
            echo "Backend CI failed"
            exit 1
          fi
          echo "Backend CI passed"
